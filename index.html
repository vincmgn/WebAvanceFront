<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.fluid.classless.min.css" />

<div id="app">
  <main style="padding: 1rem">
    <div>
      <h1>Vanilla JS Example</h1>
      <hr />
      <div style="display: flex; align-items: center; gap: 1rem; margin-top: 1rem; margin-bottom: 1rem">
        <button @click="fetchUsers">Fetch Users</button>
        <div v-if="users.length" id="options" style="display: flex; align-items: center; gap: 1rem">
          <label for="gender-select">Gender:</label>
          <select v-model="searchOptions.gender" id="gender-select" name="gender" style="margin: 0">
            <option value="none">ðŸš«</option>
            <option value="male">ðŸ‘¨</option>
            <option value="female">ðŸ‘©</option>
          </select>
          <input v-model="searchInput" type="text" placeholder="Search by name" style="min-width: 400px; margin: 0" />
        </div>
      </div>
    </div>
    <span v-if="users.length"> {{total}} / {{users.length}} users</span>
    <table>
      <thead>
        <tr>
          <th>Photo</th>
          <th>Nom</th>
          <th>Email</th>
          <th>Tel</th>
          <th style="cursor: pointer" @click="ageSort">Age <span v-if="users.length">{{ sortIcon }}</span></th>
          <th>Gender</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="user in filteredUsers" :key="user.login.username">
          <td><img :src="user.picture.medium" alt="" /></td>
          <td>{{user.name.first}} {{user.name.last}}</td>
          <td>{{user.email}}</td>
          <td>{{user.phone}}</td>
          <td>{{user.dob.age}}</td>
          <td>{{user.gender === "male" ? "ðŸ‘¨" : "ðŸ‘©"}}</td>
        </tr>
      </tbody>
    </table>
  </main>
</div>

<script>
  const { createApp, ref, onMounted, computed } = Vue;

  createApp({
    setup() {
      const users = ref([]);
      const total = ref(0);
      const searchInput = ref("");
      const searchOptions = ref({ gender: "none", age: "default", research: "" });

      const sortIcon = computed(() => {
        if (searchOptions.value.age === "default") return "â‡„";
        if (searchOptions.value.age === "desc") return "â†“";
        if (searchOptions.value.age === "asc") return "â†‘";
        return "";
      });

      const fetchUsers = async () => {
        try {
          const res = await fetch("https://randomuser.me/api/?results=20");
          const data = await res.json();
          users.value = [...users.value, ...data.results];
          total.value = users.value.length;
        } catch (error) {
          console.error("Error fetching users:", error);
          users.value = [];
          total.value = 0;
        }
      };

      const filteredUsers = computed(() => {
        let displayedUsers = [...users.value];
        displayedUsers = sortUsersByAge(displayedUsers);
        displayedUsers = filterUsersByGender(displayedUsers);
        displayedUsers = searchName(displayedUsers);

        total.value = displayedUsers.length;
        return displayedUsers;
      });

      // Sort users by age using toSorted
      const sortUsersByAge = (displayedUsers) => {
        switch (searchOptions.value.age) {
          case "default":
            return users.value;
          case "desc":
            return displayedUsers.toSorted((a, b) => a.dob.age - b.dob.age);
          case "asc":
            return displayedUsers.toSorted((a, b) => b.dob.age - a.dob.age);
          default:
            return users.value;
        }
      };

      const ageSort = () => {
        searchOptions.value.age = searchOptions.value.age === "default" ? "desc" : searchOptions.value.age === "desc" ? "asc" : "default";
      };

      // Sort users by gender
      const filterUsersByGender = (displayedUsers) => {
        let filteredUsers = [...displayedUsers];

        if (searchOptions.value.gender !== "none") {
          filteredUsers = displayedUsers.filter((user) => user.gender === searchOptions.value.gender);
        }

        return filteredUsers;
      };

      // search by name
      const searchName = (displayedUsers) => {
        const searchItems = removeAccents(searchInput.value.toLowerCase()).split(" ");
        searchOptions.value.research = searchInput.value;

        const searchUsers = displayedUsers.filter((user) => {
          const lastName = removeAccents(`${user.name.last}`.toLowerCase());
          const firstName = removeAccents(`${user.name.first}`.toLowerCase());
          return searchItems.every((word) => lastName.startsWith(word) || firstName.startsWith(word));
        });

        return searchUsers;
      };

      const removeAccents = (str) => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");

      return {
        users,
        total,
        searchOptions,
        filteredUsers,
        sortIcon,
        searchInput,
        ageSort,
        fetchUsers,
      };
    },
  }).mount("#app");
</script>
